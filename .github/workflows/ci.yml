name: Docker app CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-and-test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env from secrets
        shell: cmd
        run: |
          (
            echo # Generated from GitHub Secrets
            echo DB_HOST=${{ secrets.DB_HOST }}
            echo DB_PORT=${{ secrets.DB_PORT }}
            echo DB_NAME=${{ secrets.DB_NAME }}
            echo DB_USER=${{ secrets.DB_USER }}
            echo DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            echo APP_PORT=${{ secrets.APP_PORT }}
            echo APP_SECRET=${{ secrets.APP_SECRET }}
            echo API_KEY=${{ secrets.API_KEY }}
            echo POSTGRES_DB=${{ secrets.DB_NAME }}
            echo POSTGRES_USER=${{ secrets.DB_USER }}
            echo POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
          ) > .env

      - name: Start application with Docker Compose
        shell: cmd
        run: |
          docker compose down --remove-orphans
          docker compose up -d --build
          echo ===== docker compose ps =====
          docker compose ps

      - name: Verify containers are running
        shell: cmd
        run: |
          docker compose ps > ps.txt
          type ps.txt
          find "Up" ps.txt >nul
          if errorlevel 1 (
            echo Some containers are not running
            docker compose logs
            exit /b 1
          ) else (
            echo Containers are running
          )

      - name: Wait until app is ready (inside web container)
        shell: cmd
        run: |
          echo Waiting for /health inside web container...
          for /L %%i in (1,1,30) do (
            docker compose exec -T web python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()" >nul 2>nul && goto :ok
            echo attempt %%i/30 not ready
            ping -n 2 127.0.0.1 >nul
          )
          echo App did not become ready
          docker compose logs
          exit /b 1
          :ok
          echo App is ready

      - name: Run application tests
        shell: cmd
        run: |
          echo 1) Health check (inside web container)
          docker compose exec -T web python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()" >nul 2>nul
          if errorlevel 1 (
            echo Health endpoint is not available
            exit /b 1
          )

          echo 2) Get users count from web API (inside web container)
          for /f "usebackq tokens=*" %%i in (`docker compose exec -T web python -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8000/api/users/count').read().decode().strip())"`) do set WEB_COUNT=%%i
          if "%WEB_COUNT%"=="" (
            echo Empty response from API
            exit /b 1
          )
          echo WEB_COUNT=%WEB_COUNT%

          echo 3) Get users count from DB
          for /f "usebackq tokens=1" %%i in (`docker compose exec -T db psql -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} -t -A -c "SELECT COUNT(*) FROM users;"`) do set DB_COUNT=%%i
          if "%DB_COUNT%"=="" (
            echo Empty response from DB COUNT query
            exit /b 1
          )
          echo DB_COUNT=%DB_COUNT%

          echo 4) Compare counts
          if "%DB_COUNT%"=="%WEB_COUNT%" (
            echo Data consistency OK
          ) else (
            echo Data consistency FAILED
            exit /b 1
          )

          echo DB_COUNT=%DB_COUNT%> test-env.txt
          echo WEB_COUNT=%WEB_COUNT%>> test-env.txt

      - name: Create test report
        shell: cmd
        run: |
          echo # Deployment Test Report> test-report.md
          echo Date: %date% %time%>> test-report.md
          echo.>> test-report.md
          echo ## Checks>> test-report.md
          echo - health: OK>> test-report.md
          echo - api: /api/users/count OK>> test-report.md
          echo - db: SELECT COUNT(*) OK>> test-report.md
          echo - consistency: DB_COUNT == WEB_COUNT OK>> test-report.md
          echo.>> test-report.md
          echo ## Values>> test-report.md
          type test-env.txt>> test-report.md

      - name: Prepare sanitized .env for artifact (no secret values)
        if: always()
        shell: cmd
        run: |
          (
            echo DB_HOST=***
            echo DB_PORT=***
            echo DB_NAME=***
            echo DB_USER=***
            echo DB_PASSWORD=***
            echo APP_PORT=***
            echo APP_SECRET=***
            echo API_KEY=***
            echo POSTGRES_DB=***
            echo POSTGRES_USER=***
            echo POSTGRES_PASSWORD=***
          ) > .env

      - name: Save Docker logs
        if: always()
        shell: cmd
        run: |
          docker compose logs > deployment-logs.txt
          docker images > docker-images.txt
          docker ps -a > docker-ps.txt

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            .env
            test-report.md
            deployment-logs.txt
            docker-images.txt
            docker-ps.txt
          retention-days: 30
