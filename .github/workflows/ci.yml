name: Docker app CI

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy-and-test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env from secrets
        shell: cmd
        run: |
          echo # Generated from GitHub Secrets> .env
          echo DB_HOST=${{ secrets.DB_HOST }}>> .env
          echo DB_PORT=${{ secrets.DB_PORT }}>> .env
          echo DB_NAME=${{ secrets.DB_NAME }}>> .env
          echo DB_USER=${{ secrets.DB_USER }}>> .env
          echo DB_PASSWORD=${{ secrets.DB_PASSWORD }}>> .env
          echo APP_PORT=${{ secrets.APP_PORT }}>> .env
          echo POSTGRES_DB=${{ secrets.DB_NAME }}>> .env
          echo POSTGRES_USER=${{ secrets.DB_USER }}>> .env
          echo POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}>> .env
          type .env

      - name: Start application with Docker Compose
        shell: cmd
        run: |
          docker compose down
          docker compose up -d
          echo Waiting for containers...
          rem ждём ~30 секунд, чтобы сервисы успели подняться
          ping -n 30 127.0.0.1 >nul

      - name: Show container status
        shell: cmd
        run: |
          echo ===== docker compose ps =====
          docker compose ps

      - name: Run application tests
        shell: cmd
        run: |
          echo 1) Health check inside web container
          docker compose exec -T web python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()" 1>nul 2>nul
          if errorlevel 1 (
            echo Health endpoint is not available
            exit /b 1
          )

          echo 2) Get users count from web API (inside web container)
          for /f "usebackq tokens=*" %%i in (`docker compose exec -T web python -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8000/api/users/count').read().decode().strip())"`) do set WEB_COUNT=%%i
          echo WEB_COUNT=%WEB_COUNT%
          if "%WEB_COUNT%"=="" (
            echo Empty response from API
            exit /b 1
          )

          echo 3) Get users count from DB
          for /f "usebackq tokens=1" %%i in (`docker compose exec -T db psql -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} -t -A -c "SELECT COUNT(*) FROM users;"`) do set DB_COUNT=%%i
          echo DB_COUNT=%DB_COUNT%

          echo 4) Compare counts
          if "%DB_COUNT%"=="%WEB_COUNT%" (
            echo Data consistency OK
          ) else (
            echo Data consistency FAILED
            exit /b 1
          )

          echo DB_COUNT=%DB_COUNT%> test-env.txt
          echo WEB_COUNT=%WEB_COUNT%>> test-env.txt

      - name: Create test report
        shell: cmd
        run: |
          echo # Deployment Test Report> test-report.md
          echo Date: %date% %time%>> test-report.md
          type test-env.txt>> test-report.md

      - name: Save Docker logs
        if: always()
        shell: cmd
        run: |
          docker compose logs > deployment-logs.txt
          docker images > docker-images.txt
          docker ps -a > docker-ps.txt

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            .env
            test-report.md
            deployment-logs.txt
            docker-images.txt
            docker-ps.txt
          retention-days: 30
