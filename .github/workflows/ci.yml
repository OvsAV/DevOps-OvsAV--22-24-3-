name: Docker app CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-and-test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env from secrets
        shell: cmd
        run: |
          echo # Generated from GitHub Secrets> .env
          echo DB_HOST=${{ secrets.DB_HOST }}>> .env
          echo DB_PORT=${{ secrets.DB_PORT }}>> .env
          echo DB_NAME=${{ secrets.DB_NAME }}>> .env
          echo DB_USER=${{ secrets.DB_USER }}>> .env
          echo DB_PASSWORD=${{ secrets.DB_PASSWORD }}>> .env
          echo APP_PORT=${{ secrets.APP_PORT }}>> .env
          echo POSTGRES_DB=${{ secrets.DB_NAME }}>> .env
          echo POSTGRES_USER=${{ secrets.DB_USER }}>> .env
          echo POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}>> .env
          type .env

      - name: Start application with Docker Compose
        shell: cmd
        run: |
          docker compose down
          docker compose up -d
          echo Waiting for containers...
          timeout /T 30 /NOBREAK
          docker compose ps

      - name: Verify containers are running
        shell: cmd
        run: |
          docker compose ps > ps.txt
          type ps.txt
          find "Up" ps.txt >nul
          if errorlevel 1 (
            echo Some containers are not running
            exit /b 1
          ) else (
            echo Containers are running
          )

      - name: Run application tests
        shell: cmd
        run: |
          set PORT=${{ secrets.APP_PORT }}

          echo 1) Health check
          curl -s http://localhost:%PORT%/health > nul
          if errorlevel 1 (
            echo Health endpoint is not available
            exit /b 1
          )

          echo 2) Get users count from web API
          for /f "usebackq tokens=1" %%i in (`curl -s http://localhost:%PORT%/api/users/count`) do set WEB_COUNT=%%i
          echo WEB_COUNT=%WEB_COUNT%
          if "%WEB_COUNT%"=="" (
            echo Empty response from /api/users/count
            exit /b 1
          )

          echo 3) Get users count from DB
          for /f "usebackq tokens=1" %%i in (`docker compose exec -T db psql -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} -t -A -c "SELECT COUNT(*) FROM users;"`) do set DB_COUNT=%%i
          echo DB_COUNT=%DB_COUNT%

          echo 4) Compare counts
          if "%DB_COUNT%"=="%WEB_COUNT%" (
            echo Data consistency OK
          ) else (
            echo Data consistency FAILED
            exit /b 1
          )

          echo DB_COUNT=%DB_COUNT%> test-env.txt
          echo WEB_COUNT=%WEB_COUNT%>> test-env.txt

      - name: Create test report
        shell: cmd
        run: |
          echo # Deployment Test Report> test-report.md
          echo Date: %date% %time%>> test-report.md
          for /f "tokens=2 delims==" %%i in (test-env.txt) do (
            echo %%i>> test-report.md
          )
          echo DB_COUNT=%DB_COUNT%>> test-report.md
          echo WEB_COUNT=%WEB_COUNT%>> test-report.md

      - name: Save Docker logs
        if: always()
        shell: cmd
        run: |
          docker compose logs > deployment-logs.txt
          docker images > docker-images.txt
          docker ps -a > docker-ps.txt

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            .env
            test-report.md
            deployment-logs.txt
            docker-images.txt
            docker-ps.txt
          retention-days: 30
